<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Health Log – Auth (Cognito)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== LAYOUT GENERAL RESPONSIVE ===== */
    body{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      margin:0;
      background:#e5e7eb;
      color:#111827;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .app-shell{
      width:100%;
      max-width:420px;           /* ancho cómodo para móvil y desktop */
      margin:16px;
      background:#f9fafb;
      border-radius:24px;
      box-shadow:0 18px 45px rgba(15,23,42,.25);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    header.app-header{
      padding:12px 20px 6px;
      font-size:11px;
      text-align:center;
      color:#6b7280;
    }

    main{
      padding:0 20px 20px;
      flex:1;
      display:flex;
      flex-direction:column;
    }

    @media (min-width: 768px){
      body{
        align-items:center;    /* centrar en pantallas grandes */
      }
      .app-shell{
        max-width:460px;
      }
    }

    /* ===== COMPONENTES ===== */
    .status-top{
      font-size:11px;
      min-height:16px;
    }
    .card{padding:0;margin:0}

    /* cabecera visual del login */
    .login-header{
      background:#111827;
      color:#f9fafb;
      padding:24px 20px 28px;
      border-bottom-left-radius:40px;
      border-bottom-right-radius:40px;
      margin:0 -20px 12px;
    }
    .login-header-title{
      font-size:24px;
      line-height:1.2;
      font-weight:600;
    }
    .login-header-sub{font-size:12px;opacity:.8}

    .section-body{
      padding-top:8px;
      display:flex;
      flex-direction:column;
    }

    h2.screen-title{
      font-size:18px;
      font-weight:600;
      margin:8px 0 16px;
      text-align:center;
    }

    label{
      font-size:12px;
      color:#6b7280;
      margin-bottom:4px;
      display:block;
    }
    input,select{
      width:100%;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#fff;
      color:#111827;
      font-size:14px;
      box-sizing:border-box;
    }
    input:focus,select:focus{
      outline:none;
      border-color:#2563eb;
      box-shadow:0 0 0 1px #2563eb33;
    }
    .row{margin-bottom:12px}

    .btn{
      border:0;
      border-radius:999px;
      padding:10px 14px;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
    }
    .primary{background:#111827;color:white}
    .secondary{background:#e5e7eb;color:#111827}
    .danger{background:#ef4444;color:white}

    .muted{color:#6b7280;font-size:12px}
    .ok{color:#16a34a}
    .err{color:#dc2626}
    code{
      background:#e5e7eb;
      padding:2px 6px;
      border-radius:6px;
      font-size:11px;
    }
    .hidden{display:none}

    .avatar-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:6px}
    .avatar{
      border:1px solid #d1d5db;border-radius:10px;padding:6px;text-align:center;
      cursor:pointer;font-size:11px;background:#fff;
    }
    .avatar.selected{outline:2px solid #2563eb;border-color:#2563eb}

    .sep{height:1px;background:#e5e7eb;margin:12px 0}

    .login-footer-links{
      display:flex;justify-content:space-between;
      margin:4px 0 16px;
      font-size:12px;
      color:#6b7280;
    }
    .link-btn{
      background:none;border:none;padding:0;margin:0;
      color:#111827;font-size:12px;
      cursor:pointer;
      text-decoration:underline;
    }

    #sess-attrs,#sess-logs{
      white-space:pre-wrap;
      background:#111827;
      color:#e5e7eb;
      border-radius:10px;
      padding:10px;
      border:1px solid #1f2937;
      font-size:11px;
    }
  </style>
</head>
<body>
  <div class="app-shell"><!-- LAYOUT -->
    <header class="app-header">
      <span id="status" class="muted status-top"></span>
    </header>

    <main>
      <!-- LOGIN (pantalla inicial) -->
      <section id="view-login" class="card">
        <div class="login-header">
          <div class="login-header-title">Health<br>Log</div>
          <div class="login-header-sub">Registra tu salud día a día</div>
        </div>
        <div class="section-body">
          <h2 class="screen-title">Inicia sesión</h2>
          <div class="row">
            <label>Correo</label>
            <input type="email" id="li-email" placeholder="tucorreo@ejemplo.com">
          </div>
          <div class="row">
            <label>Contraseña</label>
            <input type="password" id="li-pass" placeholder="••••••••">
          </div>
          <div class="login-footer-links">
            <span>¿Olvidaste tu contraseña?</span>
            <button class="link-btn" id="go-signup-from-login">Crear cuenta</button>
          </div>
          <button class="btn primary" id="btn-login">Entrar</button>
        </div>
      </section>

      <!-- SIGN UP -->
      <section id="view-signup" class="card hidden">
        <div class="section-body">
          <button class="link-btn" id="back-to-login" style="margin-bottom:8px;">← Volver a iniciar sesión</button>
          <h2 class="screen-title">Crear cuenta</h2>
          <div class="row"><label>Correo</label><input type="email" id="su-email" placeholder="tucorreo@ejemplo.com"></div>
          <div class="row"><label>Contraseña</label><input type="password" id="su-pass" placeholder="mín. 8 caracteres"></div>
          <div class="row"><label>Nombre(s)</label><input type="text" id="su-first" placeholder="Nombre(s)"></div>
          <div class="row"><label>Apellido(s)</label><input type="text" id="su-last" placeholder="Apellido(s)"></div>
          <div class="row"><label>Fecha de nacimiento</label><input type="date" id="su-birth"></div>
          <div class="row">
            <label>Género</label>
            <select id="su-gender">
              <option value="H">Hombre</option>
              <option value="M">Mujer</option>
            </select>
          </div>
          <div class="row">
            <label>Nivel de actividad</label>
            <select id="su-activity">
              <option value="sedentario">Sedentario</option>
              <option value="leve">Leve</option>
              <option value="moderado">Moderado</option>
              <option value="en_forma">En forma</option>
              <option value="atleta">Atleta</option>
            </select>
          </div>

          <div class="row">
            <label>Avatar (elige 1 de 10)</label>
            <div class="avatar-grid" id="avatar-grid"></div>
          </div>

          <button class="btn primary" id="btn-signup">Registrarme</button>
        </div>
      </section>

      <!-- CONFIRM CODE -->
      <section id="view-confirm" class="card hidden">
        <div class="section-body">
          <button class="link-btn" id="back-to-login-from-confirm" style="margin-bottom:8px;">← Volver a iniciar sesión</button>
          <h2 class="screen-title">Confirmar correo</h2>
          <div class="row"><label>Correo</label><input type="email" id="cf-email" placeholder="tu email"></div>
          <div class="row"><label>Código de verificación</label><input type="text" id="cf-code" placeholder="código enviado por email"></div>
          <button class="btn primary" id="btn-confirm" style="margin-top:8px;">Confirmar</button>
          <button class="btn secondary" id="btn-resend" style="margin-top:6px;">Reenviar código</button>
        </div>
      </section>

      <!-- SESIÓN INICIADA -->
      <section id="view-session" class="card hidden">
        <div class="section-body">
          <h2 class="screen-title">Sesión iniciada</h2>
          <div class="muted" style="margin-bottom:4px;">Usuario: <span id="sess-email"></span></div>
          <div class="muted" style="margin-bottom:8px;">ID Token (recortado): <code id="sess-idtoken"></code></div>
          <div class="sep"></div>
          <div class="muted">Atributos:</div>
          <pre id="sess-attrs"></pre>
          <button class="btn danger" id="btn-logout" style="margin-top:10px;">Cerrar sesión</button>

          <div class="sep"></div>
          <div class="muted" style="margin-bottom:6px;">Pruebas con la API en AWS:</div>
          <button class="btn secondary" id="btn-test-save" style="margin-bottom:6px;">Guardar log de prueba</button>
          <button class="btn secondary" id="btn-test-load">Cargar logs</button>

          <div class="sep"></div>
          <div class="muted">Logs recibidos:</div>
          <pre id="sess-logs"></pre>
        </div>
      </section>
    </main>
  </div>

  <!-- SDK Cognito (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.7/dist/amazon-cognito-identity.min.js"></script>

  <script>
    // ======= CONFIGURA ESTO CON TUS DATOS =======
    const COGNITO_CONFIG = {
      region: 'us-east-2',
      userPoolId: 'us-east-2_vqmICro9s',
      clientId: '3urf9cvd0hrcn0ok5prog4fm2v'
    };

    const API_URL = "https://qrmjqw5uon6c4ydfocz2v2m3cm0rkggr.lambda-url.us-east-2.on.aws/";
    // ============================================

    // UI helpers
    const $ = (s)=>document.querySelector(s);
    const show = (id)=>$(id).classList.remove('hidden');
    const hide = (id)=>$(id).classList.add('hidden');
    const setStatus = (msg, cls='muted')=>{
      const el = $('#status'); el.className = cls + ' status-top'; el.textContent = msg||'';
    };

    // Avatares
    const avatarGrid = $('#avatar-grid');
    let selectedAvatar = 'avatar1';
    for (let i=1;i<=10;i++){
      const d = document.createElement('div');
      d.className = 'avatar'+(i===1?' selected':'');
      d.dataset.id = 'avatar'+i;
      d.textContent = 'avatar'+i;
      d.addEventListener('click',()=>{
        selectedAvatar = d.dataset.id;
        [...avatarGrid.children].forEach(c=>c.classList.remove('selected'));
        d.classList.add('selected');
      });
      avatarGrid.appendChild(d);
    }

    // Cognito
    const poolData = { UserPoolId: COGNITO_CONFIG.userPoolId, ClientId: COGNITO_CONFIG.clientId };
    const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

    // Navegación
    const gotoSignup = ()=>{ hide('#view-login'); show('#view-signup'); hide('#view-confirm'); hide('#view-session'); setStatus(''); };
    const gotoLogin  = ()=>{ show('#view-login'); hide('#view-signup'); hide('#view-confirm'); hide('#view-session'); setStatus(''); };
    const gotoConfirm= ()=>{ hide('#view-login'); hide('#view-signup'); show('#view-confirm'); hide('#view-session'); setStatus('Se envió un código de verificación a tu correo.', 'muted'); };
    const gotoSession= ()=>{ hide('#view-login'); hide('#view-signup'); hide('#view-confirm'); show('#view-session'); };

    $('#go-signup-from-login').addEventListener('click', gotoSignup);
    $('#back-to-login').addEventListener('click', gotoLogin);
    $('#back-to-login-from-confirm').addEventListener('click', gotoLogin);

    // ===== SIGN UP =====
    $('#btn-signup').addEventListener('click', ()=>{
      const email = $('#su-email').value.trim();
      const pass  = $('#su-pass').value.trim();
      const first = $('#su-first').value.trim();
      const last  = $('#su-last').value.trim();
      const birth = $('#su-birth').value;
      const sex   = $('#su-gender').value;
      const act   = $('#su-activity').value;

      if(!email||!pass||!first||!last||!birth){ setStatus('Faltan campos obligatorios.', 'err'); return; }

      const attrs = [
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'email', Value: email }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:firstName', Value: first }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:lastName',  Value: last }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:birthdate', Value: birth }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:gender',    Value: sex }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:activityLevel', Value: act }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:avatarId',  Value: selectedAvatar })
      ];

      userPool.signUp(email, pass, attrs, null, (err, result)=>{
        if(err){ setStatus(err.message||String(err), 'err'); return; }
        $('#cf-email').value = email;
        gotoConfirm();
      });
    });

    // ===== CONFIRMATION =====
    function getUserByEmail(email){
      return new AmazonCognitoIdentity.CognitoUser({ Username: email, Pool: userPool });
    }
    $('#btn-confirm').addEventListener('click', ()=>{
      const email = $('#cf-email').value.trim();
      const code  = $('#cf-code').value.trim();
      if(!email||!code){ setStatus('Ingresa correo y código.', 'err'); return; }
      const user = getUserByEmail(email);
      user.confirmRegistration(code, true, (err, res)=>{
        if(err){ setStatus(err.message||String(err), 'err'); return; }
        setStatus('Correo confirmado. Ya puedes iniciar sesión.', 'ok');
        gotoLogin();
        $('#li-email').value = email;
      });
    });
    $('#btn-resend').addEventListener('click', ()=>{
      const email = $('#cf-email').value.trim();
      if(!email){ setStatus('Ingresa tu correo para reenviar el código.', 'err'); return; }
      const user = getUserByEmail(email);
      user.resendConfirmationCode((err,res)=>{
        if(err){ setStatus(err.message||String(err), 'err'); return; }
        setStatus('Código reenviado. Revisa tu correo.', 'ok');
      });
    });

    // ===== LOGIN =====
    $('#btn-login').addEventListener('click', ()=>{
      const email = $('#li-email').value.trim();
      const pass  = $('#li-pass').value.trim();
      if(!email||!pass){ setStatus('Ingresa correo y contraseña.', 'err'); return; }

      const authDetails = new AmazonCognitoIdentity.AuthenticationDetails({ Username: email, Password: pass });
      const user = getUserByEmail(email);

      user.authenticateUser(authDetails, {
        onSuccess: (result)=>{
          const idToken  = result.getIdToken().getJwtToken();
          const access   = result.getAccessToken().getJwtToken();
          const refresh  = result.getRefreshToken().getToken();

          localStorage.setItem('hl_id_token', idToken);
          localStorage.setItem('hl_access_token', access);
          localStorage.setItem('hl_refresh_token', refresh);

          $('#sess-email').textContent = email;
          $('#sess-idtoken').textContent = idToken.slice(0,24)+'...';

          user.getUserAttributes((err, attrs)=>{
            if(err){ setStatus(err.message||String(err), 'err'); return; }
            const obj = {};
            attrs.forEach(a=>obj[a.getName()]=a.getValue());
            $('#sess-attrs').textContent = JSON.stringify(obj, null, 2);

            if (obj.sub) {
              localStorage.setItem('hl_user_sub', obj.sub);
            }

            gotoSession();
            setStatus('Sesión iniciada.', 'ok');
          });
        },
        onFailure: (err)=>{
          setStatus(err.message||String(err), 'err');
        }
      });
    });

    // ===== LOGOUT =====
    $('#btn-logout').addEventListener('click', ()=>{
      const cu = userPool.getCurrentUser();
      if(cu){ cu.signOut(); }
      localStorage.removeItem('hl_id_token');
      localStorage.removeItem('hl_access_token');
      localStorage.removeItem('hl_refresh_token');
      localStorage.removeItem('hl_user_sub');
      setStatus('Sesión cerrada.', 'muted');
      gotoLogin();
    });

    // ===== AUTO-UI =====
    window.addEventListener('load', ()=>{
      const cu = userPool.getCurrentUser();
      if(cu){
        cu.getSession((err,session)=>{
          if(err || !session || !session.isValid()){ gotoLogin(); return; }
          $('#li-email').value = cu.getUsername();
          $('#sess-email').textContent = cu.getUsername();
          $('#sess-idtoken').textContent = session.getIdToken().getJwtToken().slice(0,24)+'...';
          cu.getUserAttributes((err, attrs)=>{
            const obj={}; (attrs||[]).forEach(a=>obj[a.getName()]=a.getValue());
            $('#sess-attrs').textContent = JSON.stringify(obj, null, 2);
            if (obj.sub) localStorage.setItem('hl_user_sub', obj.sub);
            gotoSession();
          });
        });
      } else {
        gotoLogin();
      }
    });

    // ===== API AWS =====
    function getCurrentUserId() {
      return localStorage.getItem('hl_user_sub');
    }

    async function apiSaveTestLog() {
      const userId = getCurrentUserId();
      if (!userId) {
        setStatus("No hay userId (sub). Cierra sesión y vuelve a entrar.", "err");
        return;
      }
      const now = new Date();
      const date = now.toISOString().slice(0,10);
      const time = now.toTimeString().slice(0,5);

      const payload = {
        userId,
        date,
        time,
        type: "dolor",
        subtype: "cabeza",
        payload: { intensidad: 5 },
        notes: "Log de prueba desde el navegador"
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          console.error("Error API POST", data);
          setStatus("Error al guardar en la API", "err");
          return;
        }
        setStatus("Log de prueba guardado en DynamoDB", "ok");
      } catch (e) {
        console.error(e);
        setStatus("Error de red llamando a la API", "err");
      }
    }

    async function apiLoadLogs() {
      const userId = getCurrentUserId();
      if (!userId) {
        setStatus("No hay userId (sub). Cierra sesión y vuelve a entrar.", "err");
        return;
      }
      try {
        const url = API_URL + "?userId=" + encodeURIComponent(userId);
        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok || !data.ok) {
          console.error("Error API GET", data);
          setStatus("Error al leer de la API", "err");
          return;
        }
        const logs = data.logs || [];
        $('#sess-logs').textContent = JSON.stringify(logs, null, 2);
        setStatus(`Se cargaron ${logs.length} log(s) desde DynamoDB.`, "ok");
      } catch (e) {
        console.error(e);
        setStatus("Error de red llamando a la API", "err");
      }
    }

    $('#btn-test-save').addEventListener('click', apiSaveTestLog);
    $('#btn-test-load').addEventListener('click', apiLoadLogs);
  </script>
</body>
</html>
