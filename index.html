<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Health Log – Auth (Cognito)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background:#0b1220;color:#eaeef8}
    .wrap{max-width:860px;margin:24px auto;padding:16px}
    h1{font-size:20px;margin:0 0 16px}
    .card{background:#121a2b;border:1px solid #1e2a44;border-radius:14px;padding:16px;margin-bottom:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    label{font-size:12px;color:#9fb0d1;margin-bottom:4px;display:block}
    input,select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #2a3b63;background:#0f1728;color:#eaeef8}
    .row{margin-bottom:10px}
    .btn{border:0;border-radius:10px;padding:10px 12px;cursor:pointer}
    .primary{background:#2280ff;color:white}
    .secondary{background:#2a3b63;color:#eaeef8}
    .danger{background:#e33;color:white}
    .muted{color:#9fb0d1;font-size:12px}
    .ok{color:#71f3a3}
    .err{color:#ff8484}
    code{background:#0f1728;padding:2px 6px;border-radius:6px}
    .hidden{display:none}
    .avatar-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
    .avatar{border:1px solid #2a3b63;border-radius:10px;padding:8px;text-align:center;cursor:pointer}
    .avatar.selected{outline:2px solid #2280ff}
    .sep{height:1px;background:#1e2a44;margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Health Log — Cognito (Paso 1)</h1>

    <!-- ESTADO / MENSAJES -->
    <div id="status" class="muted"></div>

    <!-- SIGN UP -->
    <div class="card" id="view-signup">
      <h3>Crear cuenta</h3>
      <div class="grid">
        <div class="row"><label>Correo</label><input type="email" id="su-email" placeholder="tucorreo@ejemplo.com"></div>
        <div class="row"><label>Contraseña</label><input type="password" id="su-pass" placeholder="mín. 8 caracteres"></div>
        <div class="row"><label>Nombre(s)</label><input type="text" id="su-first" placeholder="Nombre(s)"></div>
        <div class="row"><label>Apellido(s)</label><input type="text" id="su-last" placeholder="Apellido(s)"></div>
        <div class="row"><label>Fecha de nacimiento</label><input type="date" id="su-birth"></div>
        <div class="row"><label>Género</label>
          <select id="su-gender">
            <option value="H">Hombre</option>
            <option value="M">Mujer</option>
          </select>
        </div>
        <div class="row"><label>Nivel de actividad</label>
          <select id="su-activity">
            <option value="sedentario">Sedentario</option>
            <option value="leve">Leve</option>
            <option value="moderado">Moderado</option>
            <option value="en_forma">En forma</option>
            <option value="atleta">Atleta</option>
          </select>
        </div>
      </div>

      <div class="row">
        <label>Avatar (elige 1 de 10)</label>
        <div class="avatar-grid" id="avatar-grid"></div>
      </div>

      <button class="btn primary" id="btn-signup">Registrarme</button>
      <div class="sep"></div>
      <div class="muted">¿Ya tienes cuenta? <button class="btn secondary" id="go-login">Ir a iniciar sesión</button></div>
      <div id="signup-msg" class="muted"></div>
    </div>

    <!-- CONFIRM CODE -->
    <div class="card hidden" id="view-confirm">
      <h3>Confirmar correo</h3>
      <div class="grid">
        <div class="row"><label>Correo</label><input type="email" id="cf-email" placeholder="tu email"></div>
        <div class="row"><label>Código de verificación</label><input type="text" id="cf-code" placeholder="código enviado por email"></div>
      </div>
      <button class="btn primary" id="btn-confirm">Confirmar</button>
      <button class="btn secondary" id="btn-resend">Reenviar código</button>
      <div id="confirm-msg" class="muted"></div>
    </div>

    <!-- LOGIN -->
    <div class="card hidden" id="view-login">
      <h3>Iniciar sesión</h3>
      <div class="grid">
        <div class="row"><label>Correo</label><input type="email" id="li-email"></div>
        <div class="row"><label>Contraseña</label><input type="password" id="li-pass"></div>
      </div>
      <button class="btn primary" id="btn-login">Entrar</button>
      <div id="login-msg" class="muted"></div>
    </div>

    <!-- LOGGED IN -->
    <div class="card hidden" id="view-session">
      <h3>Sesión iniciada</h3>
      <div class="muted">Usuario: <span id="sess-email"></span></div>
      <div class="muted">ID Token (recortado): <code id="sess-idtoken"></code></div>
      <div class="sep"></div>
      <div class="muted">Atributos:</div>
      <pre id="sess-attrs" style="white-space:pre-wrap;background:#0f1728;border:1px solid #2a3b63;border-radius:10px;padding:10px;"></pre>
      <button class="btn danger" id="btn-logout">Cerrar sesión</button>

      <!-- NUEVO: Controles para probar la API de AWS (Lambda + DynamoDB) -->
      <div class="sep"></div>
      <div class="muted" style="margin-bottom:6px;">Pruebas con la API en AWS:</div>
      <button class="btn secondary" id="btn-test-save">Guardar log de prueba</button>
      <button class="btn secondary" id="btn-test-load">Cargar logs</button>

      <div class="sep"></div>
      <div class="muted">Logs recibidos:</div>
      <pre id="sess-logs" style="white-space:pre-wrap;background:#0f1728;border:1px solid #2a3b63;border-radius:10px;padding:10px;max-height:200px;overflow:auto;"></pre>
      <!-- FIN NUEVO -->
    </div>
  </div>

  <!-- SDK Cognito (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.7/dist/amazon-cognito-identity.min.js"></script>

  <script>
    // ======= CONFIGURA ESTO CON TUS DATOS =======
    const COGNITO_CONFIG = {
      region: 'us-east-2',                // ej. 'us-east-2'
      userPoolId: 'us-east-2_vqmICro9s',  // tu User Pool ID
      clientId: '3urf9cvd0hrcn0ok5prog4fm2v'   // tu App Client ID
    };

    const API_URL = "https://qrmjqw5uon6c4ydfocz2v2m3cm0rkggr.lambda-url.us-east-2.on.aws/"; // NUEVO: URL de la Lambda
    // ============================================

    // UI helpers
    const $ = (s)=>document.querySelector(s);
    const show = (id)=>$(id).classList.remove('hidden');
    const hide = (id)=>$(id).classList.add('hidden');
    const setStatus = (msg, cls='muted')=>{
      const el = $('#status'); el.className=cls; el.textContent = msg||'';
    };

    // Avatares (10 opciones simples; sustitúyelas por imágenes reales luego)
    const avatarGrid = $('#avatar-grid');
    let selectedAvatar = 'avatar1';
    for (let i=1;i<=10;i++){
      const d = document.createElement('div');
      d.className = 'avatar'+(i===1?' selected':'');
      d.dataset.id = 'avatar'+i;
      d.textContent = 'avatar'+i;
      d.addEventListener('click',()=>{
        selectedAvatar = d.dataset.id;
        [...avatarGrid.children].forEach(c=>c.classList.remove('selected'));
        d.classList.add('selected');
      });
      avatarGrid.appendChild(d);
    }

    // Cognito objects
    const poolData = { UserPoolId: COGNITO_CONFIG.userPoolId, ClientId: COGNITO_CONFIG.clientId };
    const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);

    // Navegación básica
    const gotoSignup = ()=>{ show('#view-signup'); hide('#view-login'); hide('#view-confirm'); hide('#view-session'); setStatus(''); };
    const gotoLogin  = ()=>{ hide('#view-signup'); show('#view-login'); hide('#view-confirm'); hide('#view-session'); setStatus(''); };
    const gotoConfirm= ()=>{ hide('#view-signup'); hide('#view-login'); show('#view-confirm'); hide('#view-session'); setStatus('Se envió un código de verificación a tu correo.', 'muted'); };
    const gotoSession= ()=>{ hide('#view-signup'); hide('#view-login'); hide('#view-confirm'); show('#view-session'); };

    $('#go-login').addEventListener('click', gotoLogin);

    // ======= SIGN UP =======
    $('#btn-signup').addEventListener('click', ()=>{
      const email = $('#su-email').value.trim();
      const pass  = $('#su-pass').value.trim();
      const first = $('#su-first').value.trim();
      const last  = $('#su-last').value.trim();
      const birth = $('#su-birth').value; // YYYY-MM-DD
      const sex   = $('#su-gender').value;   // 'H' | 'M'
      const act   = $('#su-activity').value;

      if(!email||!pass||!first||!last||!birth){ setStatus('Faltan campos obligatorios.', 'err'); return; }

      const attrs = [
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'email', Value: email }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:firstName', Value: first }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:lastName',  Value: last }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:birthdate', Value: birth }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:gender',    Value: sex }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:activityLevel', Value: act }),
        new AmazonCognitoIdentity.CognitoUserAttribute({ Name:'custom:avatarId',  Value: selectedAvatar })
      ];

      userPool.signUp(email, pass, attrs, null, (err, result)=>{
        if(err){ setStatus(err.message||String(err), 'err'); return; }
        $('#cf-email').value = email; // precargar para confirmar
        gotoConfirm();
      });
    });

    // ======= CONFIRMATION (code) =======
    let lastCognitoUser = null;
    function getUserByEmail(email){
      return new AmazonCognitoIdentity.CognitoUser({ Username: email, Pool: userPool });
    }
    $('#btn-confirm').addEventListener('click', ()=>{
      const email = $('#cf-email').value.trim();
      const code  = $('#cf-code').value.trim();
      if(!email||!code){ setStatus('Ingresa correo y código.', 'err'); return; }
      const user = getUserByEmail(email);
      user.confirmRegistration(code, true, (err, res)=>{
        if(err){ setStatus(err.message||String(err), 'err'); return; }
        setStatus('Correo confirmado. Ya puedes iniciar sesión.', 'ok');
        gotoLogin();
        $('#li-email').value = email;
      });
    });
    $('#btn-resend').addEventListener('click', ()=>{
      const email = $('#cf-email').value.trim();
      if(!email){ setStatus('Ingresa tu correo para reenviar el código.', 'err'); return; }
      const user = getUserByEmail(email);
      user.resendConfirmationCode((err,res)=>{
        if(err){ setStatus(err.message||String(err), 'err'); return; }
        setStatus('Código reenviado. Revisa tu correo.', 'ok');
      });
    });

    // ======= LOGIN =======
    $('#btn-login').addEventListener('click', ()=>{
      const email = $('#li-email').value.trim();
      const pass  = $('#li-pass').value.trim();
      if(!email||!pass){ setStatus('Ingresa correo y contraseña.', 'err'); return; }

      const authDetails = new AmazonCognitoIdentity.AuthenticationDetails({ Username: email, Password: pass });
      const user = getUserByEmail(email);

      user.authenticateUser(authDetails, {
        onSuccess: (result)=>{
          // tokens
          const idToken  = result.getIdToken().getJwtToken();
          const access   = result.getAccessToken().getJwtToken();
          const refresh  = result.getRefreshToken().getToken();
          // guardar para siguientes pasos (Lambda)
          localStorage.setItem('hl_id_token', idToken);
          localStorage.setItem('hl_access_token', access);
          localStorage.setItem('hl_refresh_token', refresh);

          $('#sess-email').textContent = email;
          $('#sess-idtoken').textContent = idToken.slice(0,24)+'...';

          // obtener atributos
          user.getUserAttributes((err, attrs)=>{
            if(err){ setStatus(err.message||String(err), 'err'); return; }
            const obj = {};
            attrs.forEach(a=>obj[a.getName()]=a.getValue());
            $('#sess-attrs').textContent = JSON.stringify(obj, null, 2);

            if (obj.sub) {                       // NUEVO: guardar sub como userId
              localStorage.setItem('hl_user_sub', obj.sub);
            }

            gotoSession();
            setStatus('Sesión iniciada.', 'ok');
          });
        },
        onFailure: (err)=>{
          setStatus(err.message||String(err), 'err');
        }
      });
    });

    // ======= LOGOUT =======
    $('#btn-logout').addEventListener('click', ()=>{
      const cu = userPool.getCurrentUser();
      if(cu){ cu.signOut(); }
      localStorage.removeItem('hl_id_token');
      localStorage.removeItem('hl_access_token');
      localStorage.removeItem('hl_refresh_token');
      localStorage.removeItem('hl_user_sub'); // NUEVO: limpiar también el userId
      setStatus('Sesión cerrada.', 'muted');
      gotoLogin();
    });

    // ======= AUTO-UI (si ya había sesión) =======
    window.addEventListener('load', ()=>{
      const cu = userPool.getCurrentUser();
      if(cu){
        cu.getSession((err,session)=>{
          if(err || !session || !session.isValid()){ gotoLogin(); return; }
          $('#li-email').value = cu.getUsername();
          $('#sess-email').textContent = cu.getUsername();
          $('#sess-idtoken').textContent = session.getIdToken().getJwtToken().slice(0,24)+'...';
          cu.getUserAttributes((err, attrs)=>{
            const obj={}; (attrs||[]).forEach(a=>obj[a.getName()]=a.getValue());
            $('#sess-attrs').textContent = JSON.stringify(obj, null, 2);

            if (obj.sub) {                       // NUEVO: también aquí, por si entra con sesión previa
              localStorage.setItem('hl_user_sub', obj.sub);
            }

            gotoSession();
          });
        });
      } else {
        gotoSignup();
      }
    });

    // ======= NUEVO: funciones para llamar a la API de AWS (Lambda + DynamoDB) =======
    function getCurrentUserId() {
      return localStorage.getItem('hl_user_sub');
    }

    async function apiSaveTestLog() {
      const userId = getCurrentUserId();
      if (!userId) {
        setStatus("No hay userId (sub). Cierra sesión y vuelve a entrar.", "err");
        return;
      }

      const now = new Date();
      const date = now.toISOString().slice(0,10);      // YYYY-MM-DD
      const time = now.toTimeString().slice(0,5);      // HH:MM

      const payload = {
        userId,
        date,
        time,
        type: "dolor",
        subtype: "cabeza",
        payload: { intensidad: 5 },
        notes: "Log de prueba desde el navegador"
      };

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          console.error("Error API POST", data);
          setStatus("Error al guardar en la API", "err");
          return;
        }
        setStatus("Log de prueba guardado en DynamoDB", "ok");
      } catch (e) {
        console.error(e);
        setStatus("Error de red llamando a la API", "err");
      }
    }

    async function apiLoadLogs() {
      const userId = getCurrentUserId();
      if (!userId) {
        setStatus("No hay userId (sub). Cierra sesión y vuelve a entrar.", "err");
        return;
      }

      try {
        const url = API_URL + "?userId=" + encodeURIComponent(userId);
        const res = await fetch(url);
        const data = await res.json();
        if (!res.ok || !data.ok) {
          console.error("Error API GET", data);
          setStatus("Error al leer de la API", "err");
          return;
        }
        const logs = data.logs || [];
        $('#sess-logs').textContent = JSON.stringify(logs, null, 2);
        setStatus(`Se cargaron ${logs.length} log(s) desde DynamoDB.`, "ok");
      } catch (e) {
        console.error(e);
        setStatus("Error de red llamando a la API", "err");
      }
    }

    const btnTestSave = $('#btn-test-save');
    const btnTestLoad = $('#btn-test-load');
    if (btnTestSave) btnTestSave.addEventListener('click', apiSaveTestLog);
    if (btnTestLoad) btnTestLoad.addEventListener('click', apiLoadLogs);
    // ======= FIN NUEVO =======
  </script>
</body>
</html>
